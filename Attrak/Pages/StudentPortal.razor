@page "/student-portal"
@using Attrak.Services
@using AttrackSharedClass.Models
@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject HttpClient Http
@layout Loginpage
<PageTitle>Student Portal - Attrak</PageTitle>

<style>
    .fade-in {
        animation: fadeIn 0.4s ease-out forwards;
    }
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .form-control, .form-select {
        border: 1px solid #dee2e6 !important;
        background-color: #fcfcfc !important;
        transition: all 0.2s ease-in-out;
    }
    .form-control:focus, .form-select:focus {
        background-color: #ffffff !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
</style>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="row w-100">
        <div class="col-md-10 col-lg-10 mx-auto">
            <div class="row">
                <!-- Image Section -->
                <div class="col-md-6 d-flex align-items-center justify-content-end pe-4">
                    <div class="text-center">
                        <img src="/as.png" alt="QR Code Attendance" class="img-fluid" style="max-height: 700px; max-width: 100%;" />
                    </div>
                </div>
                
                <!-- Form Section -->
                <div class="col-md-6 d-flex align-items-center justify-content-start ps-4">
                    <div class="card shadow-lg border-0 rounded-4" style="width: 100%; max-width: 550px; overflow: hidden;">
                        <div class="card-body p-4 p-md-5">
                            <div class="text-center mb-4">
                                <h2 class="fw-bold text-primary">SARDO-TRAKCARE</h2>
                                <p class="text-muted">Attendance Management System</p>
                            </div>

                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-4" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(isLoginTab ? "active" : "")" id="login-tab" type="button" @onclick="() => SwitchTab(true)">
                                Login
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(!isLoginTab ? "active" : "")" id="register-tab" type="button" @onclick="() => SwitchTab(false)">
                                Register
                            </button>
                        </li>
                    </ul>

                    <!-- Login Form -->
                    @if (isLoginTab)
                    {
                        <div class="fade-in">
                        <EditForm Model="loginRequest" OnValidSubmit="HandleLogin">
                            <DataAnnotationsValidator />
                            
                            <div class="mb-4 mt-3">
                                <label for="username" class="form-label text-muted small fw-bold mb-1">Username</label>
                                <InputText id="username" class="form-control py-3 rounded-3" @bind-Value="loginRequest.Username" placeholder="Enter your username" />
                                <ValidationMessage For="@(() => loginRequest.Username)" class="text-danger small" />
                            </div>

                            <div class="mb-4">
                                <label for="password" class="form-label text-muted small fw-bold mb-1">Password</label>
                                <InputText id="password" type="password" class="form-control py-3 rounded-3" @bind-Value="loginRequest.Password" placeholder="Enter your password" />
                                <ValidationMessage For="@(() => loginRequest.Password)" class="text-danger small" />
                            </div>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert">
                                    @errorMessage
                                </div>
                            }

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Logging in...</span>
                                    }
                                    else
                                    {
                                        <span>Login</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                        </div>
                    }

                    <!-- Registration Form -->
                    @if (!isLoginTab)
                    {
                        <div class="fade-in">
                        <EditForm Model="studentRegisterRequest" OnValidSubmit="HandleStudentRegister">
                            <DataAnnotationsValidator />
                            
                            <!-- Personal Information -->
                            <h6 class="text-secondary fw-bold text-uppercase mb-3 mt-2" style="font-size: 0.85rem; letter-spacing: 1px;">Personal Information</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="reg-fullname" class="form-label text-muted small fw-bold mb-1">Full Name</label>
                                    <InputText id="reg-fullname" class="form-control py-2 text-uppercase rounded-3" @bind-Value="studentRegisterRequest.FullName" @oninput="OnFullNameChanged" placeholder="e.g. JUAN DELA CRUZ" />
                                    <ValidationMessage For="@(() => studentRegisterRequest.FullName)" class="text-danger small" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="reg-gender" class="form-label text-muted small fw-bold mb-1">Gender</label>
                                    <InputSelect id="reg-gender" class="form-select py-2 rounded-3" @bind-Value="studentRegisterRequest.Gender">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => studentRegisterRequest.Gender)" class="text-danger small" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="reg-parentsnumber" class="form-label text-muted small fw-bold mb-1">Parent's Contact Number (11-digit)</label>
                                    <InputText id="reg-parentsnumber" class="form-control py-2 rounded-3" @bind-Value="studentRegisterRequest.ParentsNumber" placeholder="09XXXXXXXXX" maxlength="11" />
                                    <ValidationMessage For="@(() => studentRegisterRequest.ParentsNumber)" class="text-danger small" />
                                </div>
                            </div>

                            <!-- School Information -->
                            <h6 class="text-secondary fw-bold text-uppercase mb-3 mt-3" style="font-size: 0.85rem; letter-spacing: 1px;">School & Section</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="reg-school" class="form-label text-muted small fw-bold mb-1">School Name</label>
                                    <div class="position-relative">
                                        <InputText id="reg-school" class="form-control py-2 rounded-3" @bind-Value="studentRegisterRequest.SchoolName" @oninput="OnSchoolSearchChanged" placeholder="Start typing to search..." />
                                        <ValidationMessage For="@(() => studentRegisterRequest.SchoolName)" class="text-danger small" />
                                        
                                        @if (showSchoolDropdown && filteredSchools.Any())
                                        {
                                            <div class="position-absolute w-100 bg-white border rounded shadow-lg mt-1" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                @foreach (var school in filteredSchools.Take(10))
                                                {
                                                    <div class="p-3 border-bottom cursor-pointer hover-bg-light transition-all" @onclick="async () => await SelectSchool(school)" style="cursor: pointer;">
                                                        <div class="fw-bold text-primary">@school.SchoolName</div>
                                                        <small class="text-muted d-block" style="line-height: 1.2;">@school.Region, @school.Division</small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="reg-gradelevel" class="form-label text-muted small fw-bold mb-1">Grade Level</label>
                                    <InputSelect id="reg-gradelevel" class="form-select py-2 rounded-3" @bind-Value="studentRegisterRequest.GradeLevel" @onchange="OnGradeLevelChanged" disabled="@(string.IsNullOrEmpty(studentRegisterRequest.SchoolName))">
                                        <option value="">Select Level</option>
                                        <option value="7">Grade 7</option>
                                        <option value="8">Grade 8</option>
                                        <option value="9">Grade 9</option>
                                        <option value="10">Grade 10</option>
                                        <option value="11">Grade 11</option>
                                        <option value="12">Grade 12</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => studentRegisterRequest.GradeLevel)" class="text-danger small" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="reg-section" class="form-label text-muted small fw-bold mb-1">Section</label>
                                    <div class="position-relative">
                                        <InputText id="reg-section" class="form-control py-2 text-uppercase rounded-3" @bind-Value="studentRegisterRequest.Section" @oninput="OnSectionSearchChanged" placeholder="Search section..." disabled="@(string.IsNullOrEmpty(studentRegisterRequest.SchoolName) || studentRegisterRequest.GradeLevel < 7)" />
                                        <ValidationMessage For="@(() => studentRegisterRequest.Section)" class="text-danger small" />
                                        
                                        @if (showSectionDropdown && filteredSections.Any())
                                        {
                                            <div class="position-absolute w-100 bg-white border rounded shadow-lg mt-1" style="z-index: 1000; max-height: 150px; overflow-y: auto;">
                                                @foreach (var sec in filteredSections.Take(10))
                                                {
                                                    <div class="p-2 px-3 border-bottom cursor-pointer hover-bg-light transition-all" @onclick="() => SelectSection(sec)" style="cursor: pointer;">
                                                        <div class="fw-bold text-primary text-uppercase">@sec</div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else if (showSectionDropdown && !string.IsNullOrEmpty(studentRegisterRequest.Section) && !filteredSections.Any())
                                        {
                                            <div class="position-absolute w-100 bg-white border rounded shadow mt-1 p-2 small text-muted" style="z-index: 1000;">
                                                No existing section found. You can type it manually.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (ShouldShowStrandDropdown())
                            {
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="p-3 bg-light rounded-3 border border-success border-opacity-25">
                                            <label for="reg-strand" class="form-label text-success small fw-bold mb-1">Strand & Track (Senior High)</label>
                                            <InputSelect id="reg-strand" class="form-select border-0 py-2 rounded-3" style="background-color: white;" @bind-Value="studentRegisterRequest.Strand">
                                                <option value="">Select Strand</option>
                                                <option value="STEM">Science, Technology, Engineering, and Mathematics</option>
                                                <option value="ABM">Accountancy, Business and Management</option>
                                                <option value="HUMSS">Humanities and Social Sciences</option>
                                                <option value="GAS">General Academic Strand</option>
                                                <option value="TVL">Technical-Vocational-Livelihood</option>
                                            </InputSelect>
                                            <ValidationMessage For="@(() => studentRegisterRequest.Strand)" class="text-danger small" />
                                        </div>
                                    </div>
                                </div>
                            }
                            
                            <!-- Login Credentials -->
                            <h6 class="text-secondary fw-bold text-uppercase mb-3 mt-3" style="font-size: 0.85rem; letter-spacing: 1px;">Account Setup</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="reg-email" class="form-label text-muted small fw-bold mb-1">Email Address</label>
                                    <InputText id="reg-email" type="email" class="form-control py-2 rounded-3" @bind-Value="studentRegisterRequest.Email" placeholder="Enter your email for account recovery" />
                                    <ValidationMessage For="@(() => studentRegisterRequest.Email)" class="text-danger small" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="reg-username" class="form-label text-muted small fw-bold mb-1">Username</label>
                                    <InputText id="reg-username" class="form-control py-2 rounded-3" @bind-Value="studentRegisterRequest.Username" @oninput="OnUsernameChanged" placeholder="Choose username" />
                                    <ValidationMessage For="@(() => studentRegisterRequest.Username)" class="text-danger small" />
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="reg-password" class="form-label text-muted small fw-bold mb-1">Password</label>
                                    <InputText id="reg-password" type="password" class="form-control py-2 rounded-3" @bind-Value="studentRegisterRequest.Password" @oninput="OnPasswordChanged" placeholder="Create password" />
                                    <ValidationMessage For="@(() => studentRegisterRequest.Password)" class="text-danger small" />
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert">
                                    @errorMessage
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="alert alert-success" role="alert">
                                    @successMessage
                                </div>
                            }

                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Registering...</span>
                                    }
                                    else
                                    {
                                        <span>Register as Student</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                        </div>
                    }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private StudentRegisterRequest studentRegisterRequest = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;
    private bool isLoginTab = true;

    // School search functionality
    private List<SchoolInfo> allSchools = new();
    private List<SchoolInfo> filteredSchools = new();
    private bool showSchoolDropdown = false;
    private Timer? schoolSearchTimer;

    // Section search functionality
    private List<string> availableSections = new();
    private List<string> filteredSections = new();
    private bool showSectionDropdown = false;
    private Timer? sectionSearchTimer;

    public class StudentRegisterRequest
    {
        [Required]
        [MaxLength(50)]
        public string Username { get; set; } = string.Empty;
        
        [Required]
        [EmailAddress]
        [MaxLength(100)]
        public string Email { get; set; } = string.Empty;
        
        [Required]
        [MinLength(6)]
        public string Password { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(100)]
        public string FullName { get; set; } = string.Empty;
        
        [Required]
        [Range(7, 12, ErrorMessage = "Grade level must be between 7 and 12")]
        public int GradeLevel { get; set; }
        
        [Required]
        [MaxLength(50)]
        public string Section { get; set; } = string.Empty;
        
        [MaxLength(50)]
        public string? Strand { get; set; }
        
        [Required]
        [MaxLength(200)]
        public string SchoolName { get; set; } = string.Empty;
        
        [Required]
        [RegularExpression(@"^09\d{9}$", ErrorMessage = "Contact number must start with '09' and be 11 digits long.")]
        public string ParentsNumber { get; set; } = string.Empty;
        
        [Required]
        [MaxLength(10)]
        public string Gender { get; set; } = string.Empty;
    }


    protected override async Task OnInitializedAsync()
    {
        // Check if user is already logged in
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            Navigation.NavigateTo("/dashboard");
        }

        // Load all schools for search
        await LoadAllSchools();
    }

    private void SwitchTab(bool showLogin)
    {
        isLoginTab = showLogin;
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private void OnUsernameChanged(ChangeEventArgs e)
    {
        studentRegisterRequest.Username = e.Value?.ToString() ?? "";
    }

    private void OnPasswordChanged(ChangeEventArgs e)
    {
        studentRegisterRequest.Password = e.Value?.ToString() ?? "";
    }

    private void OnFullNameChanged(ChangeEventArgs e)
    {
        studentRegisterRequest.FullName = e.Value?.ToString()?.ToUpper() ?? "";
    }

    private void OnLoginUsernameChanged(ChangeEventArgs e)
    {
        loginRequest.Username = e.Value?.ToString() ?? "";
    }

    private void OnLoginPasswordChanged(ChangeEventArgs e)
    {
        loginRequest.Password = e.Value?.ToString() ?? "";
    }

    private async Task HandleLogin()
    {
        if (isLoading) return;

        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            var response = await AuthService.LoginAsync(loginRequest);
            
            if (response.Success)
            {
                Navigation.NavigateTo("/student-dashboard");
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during login. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleStudentRegister()
    {
        if (isLoading) return;

        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync($"{ApiConfig.BaseUrl}api/register/student", studentRegisterRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<StudentRegisterResponse>();
                if (result?.Success == true)
                {
                    successMessage = "Registration successful! Redirecting to your QR code...";
                    studentRegisterRequest = new(); // Clear form
                    
                    // Redirect to QR code page after a short delay
                    await Task.Delay(2000);
                    if (!string.IsNullOrEmpty(result.StudentId))
                    {
                        Navigation.NavigateTo($"/student-qr/{result.StudentId}");
                    }
                    else
                    {
                        // Switch to login tab if no StudentId
                        isLoginTab = true;
                    }
                }
                else
                {
                    errorMessage = result?.Message ?? "Registration failed";
                }
            }
            else
            {
                var errorResult = await response.Content.ReadFromJsonAsync<StudentRegisterResponse>();
                errorMessage = errorResult?.Message ?? "Registration failed";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during registration. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadAllSchools()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<SchoolInfo>>($"{ApiConfig.BaseUrl}api/register/schools/all");
            allSchools = response ?? new List<SchoolInfo>();
        }
        catch (Exception ex)
        {
            // Handle error silently for now
            allSchools = new List<SchoolInfo>();
        }
    }

    private void OnSchoolSearchChanged(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString() ?? "";
        studentRegisterRequest.SchoolName = searchTerm;

        // Cancel previous timer
        schoolSearchTimer?.Dispose();

        if (string.IsNullOrEmpty(searchTerm))
        {
            showSchoolDropdown = false;
            filteredSchools.Clear();
            StateHasChanged();
            return;
        }

        // Set a timer to delay the search
        schoolSearchTimer = new Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                filteredSchools = allSchools
                    .Where(s => s.SchoolName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                               s.Region.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                               s.Division.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                    .OrderBy(s => s.SchoolName)
                    .ToList();

                showSchoolDropdown = filteredSchools.Any();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task SelectSchool(SchoolInfo school)
    {
        studentRegisterRequest.SchoolName = school.SchoolName;
        showSchoolDropdown = false;
        filteredSchools.Clear();
        await FetchAvailableSections();
        StateHasChanged();
    }

    private async Task FetchAvailableSections()
    {
        if (string.IsNullOrEmpty(studentRegisterRequest.SchoolName) || studentRegisterRequest.GradeLevel < 7)
        {
            availableSections.Clear();
            return;
        }

        try
        {
            var url = $"{ApiConfig.BaseUrl}api/register/sections?schoolName={Uri.EscapeDataString(studentRegisterRequest.SchoolName)}&gradeLevel={studentRegisterRequest.GradeLevel}";
            var response = await Http.GetFromJsonAsync<List<string>>(url);
            availableSections = response ?? new List<string>();
        }
        catch
        {
            availableSections.Clear();
        }
    }

    private void OnSectionSearchChanged(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString()?.ToUpper() ?? "";
        studentRegisterRequest.Section = searchTerm;

        sectionSearchTimer?.Dispose();

        if (string.IsNullOrEmpty(searchTerm))
        {
            showSectionDropdown = false;
            filteredSections.Clear();
            StateHasChanged();
            return;
        }

        sectionSearchTimer = new Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                filteredSections = availableSections
                    .Where(s => s.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                    .OrderBy(s => s)
                    .ToList();

                // If no matching existing section, we still shouldn't prevent them from manually typing adding a section, 
                // but the prompt is to "make section field searchable from available section", so they can type as normal anyway.
                showSectionDropdown = true; // Always show dropdown to provide feedback (matches or hint)
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private void SelectSection(string section)
    {
        studentRegisterRequest.Section = section;
        showSectionDropdown = false;
        filteredSections.Clear();
        StateHasChanged();
    }

    public class StudentRegisterResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string? StudentId { get; set; }
        public string? UserId { get; set; }
        public string? QRCodeData { get; set; }
    }

    private bool ShouldShowStrandDropdown()
    {
        return studentRegisterRequest.GradeLevel == 11 || studentRegisterRequest.GradeLevel == 12;
    }

    private async Task OnGradeLevelChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int gradeLevel))
        {
            studentRegisterRequest.GradeLevel = gradeLevel;
        }
        else
        {
            studentRegisterRequest.GradeLevel = 0; // Default value
        }
        
        // Clear strand selection if not Grade 11 or 12
        if (!ShouldShowStrandDropdown())
        {
            studentRegisterRequest.Strand = "";
        }
        
        await FetchAvailableSections();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        schoolSearchTimer?.Dispose();
        sectionSearchTimer?.Dispose();
    }
}
