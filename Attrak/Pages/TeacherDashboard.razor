@page "/teacher-dashboard"
@using AttrackSharedClass.Models
@using Attrak.Services
@inject IAuthService AuthService
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@layout Layoutall
@implements IDisposable

<PageTitle>Teacher Dashboard - Attrak</PageTitle>

<div class="container-fluid">

    <!-- Header -->
    <div class="row bg-primary text-white p-3 mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h4 class="mb-2">
                        <i class="fas fa-chalkboard-teacher me-2"></i>Teacher Dashboard
                    </h4>
                    <p class="mb-0 opacity-75">Student Attendance Monitoring System</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm" @onclick="RefreshData" title="Refresh Data">
                        <i class="fas fa-sync-alt me-2"></i> Refresh
                    </button>
                    <button class="btn btn-outline-light btn-lg" @onclick="Logout">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </button>
                </div>
            </div>
            @if (isLoading)
            {
                <div class="mt-2">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Loading data...</span>
                </div>
            }
        </div>
    </div>


    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>@errorMessage
                </div>
            </div>
        </div>
    }


    <!-- Class Information Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Class Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">Grade Level</h6>
                                <h4 class="text-primary mb-0">Grade @(classInfo?.GradeLevel ?? 0)</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">Section</h6>
                                <h4 class="text-success mb-0">@(classInfo?.Section ?? "N/A")</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">School</h6>
                                <h4 class="text-warning mb-0">@(classInfo?.SchoolName ?? "N/A")</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">Adviser Name</h6>
                                <h4 class="text-info mb-0">@(classInfo?.FullName ?? "N/A")</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h3 class="mb-1">@(students?.Count ?? 0)</h3>
                    <p class="mb-0">Total Number of Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3 class="mb-1">@(studentsAtRisk?.Count ?? 0)</h3>
                    <p class="mb-0">Students at Risk (Absences)</p>
                    @if (studentsAtRisk?.Count > 0)
                    {
                        <small class="d-block mt-1">
                            <i class="fas fa-flag me-1"></i>
                            @studentsAtRisk.Count student(s) with 3+ absences
                        </small>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Student Attendance Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Student Attendance Report
                        </h5>
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-primary btn-sm" @onclick="NavigateToDailyAttendance">
                                <i class="fas fa-calendar-day me-1"></i>Daily Attendance
                            </button>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-calendar me-1"></i>As of @DateTime.Now.ToString("MMMM")
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">Gender</th>
                                    <th class="border-0">Full Name</th>
                                    <th class="border-0 text-center">No. of Absences</th>
                                    <th class="border-0 text-center">Status</th>
                                    <th class="border-0 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (students?.Any() == true)
                                {
                                    var maleStudents = students.Where(s => s.Gender?.ToLower() == "male").ToList();
                                    var femaleStudents = students.Where(s => s.Gender?.ToLower() == "female").ToList();

                                    @if (maleStudents.Any())
                                    {
                                        <!-- Male Students -->
                                        <tr class="table-primary">
                                            <td colspan="5" class="fw-bold text-primary">
                                                <i class="fas fa-male me-2"></i>Male Students
                                            </td>
                                        </tr>
                                        @foreach (var student in maleStudents)
                                        {
                                            var absences = student.AbsenceCount;
                                            var status = student.Status;
                                            <tr>
                                                <td class="ps-4">
                                                    <i class="fas fa-male text-primary me-2"></i>Male
                                                </td>
                                                <td class="fw-semibold">@student.FullName</td>
                                                <td class="text-center">
                                                    <span class="badge @(absences >= 3 ? "bg-danger" : absences >= 1 ? "bg-warning" : "bg-success") fs-6">@absences</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge @(absences >= 3 ? "bg-danger" : absences >= 1 ? "bg-warning" : "bg-success")">
                                                        <i class="fas fa-@(absences >= 3 ? "flag" : absences >= 1 ? "exclamation" : "check") me-1"></i>@status
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-outline-info" @onclick="() => ViewStudentDetails(student.StudentId)">
                                                        <i class="fas fa-eye me-1"></i>View Details
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }

                                    @if (femaleStudents.Any())
                                    {
                                        <!-- Female Students -->
                                        <tr class="table-info">
                                            <td colspan="5" class="fw-bold text-info">
                                                <i class="fas fa-female me-2"></i>Female Students
                                            </td>
                                        </tr>
                                        @foreach (var student in femaleStudents)
                                        {
                                            var absences = student.AbsenceCount;
                                            var status = student.Status;
                                            <tr>
                                                <td class="ps-4">
                                                    <i class="fas fa-female text-pink me-2"></i>Female
                                                </td>
                                                <td class="fw-semibold">@student.FullName</td>
                                                <td class="text-center">
                                                    <span class="badge @(absences >= 3 ? "bg-danger" : absences >= 1 ? "bg-warning" : "bg-success") fs-6">@absences</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge @(absences >= 3 ? "bg-danger" : absences >= 1 ? "bg-warning" : "bg-success")">
                                                        <i class="fas fa-@(absences >= 3 ? "flag" : absences >= 1 ? "exclamation" : "check") me-1"></i>@status
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-outline-info" @onclick="() => ViewStudentDetails(student.StudentId)">
                                                        <i class="fas fa-eye me-1"></i>View Details
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <p class="mb-0">No students found for this class.</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-primary btn-lg" @onclick="async () => await ExportReport()">
                    <i class="fas fa-download me-2"></i>Export Report
                </button>
                <button class="btn btn-info btn-lg" @onclick="GenerateAnalytics">
                    <i class="fas fa-chart-bar me-2"></i>Generate Analytics
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Student>? students;
    private List<Student>? studentsAtRisk;
    private UserInfo? teacherInfo;
    private TeacherClassInfo? classInfo;
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private Dictionary<string, int> studentAbsences = new();

    protected override async Task OnInitializedAsync()
    {
        teacherInfo = await AuthService.GetCurrentUserAsync();
        
        if (teacherInfo == null)
        {
            errorMessage = "Please log in to access this dashboard.";
            isLoading = false;
            return;
        }

        if (teacherInfo.UserType != UserType.Teacher)
        {
            errorMessage = "Access denied. This dashboard is only for teachers.";
            isLoading = false;
            return;
        }

        // Load teacher data from API
        await LoadTeacherData();
    }

    private async Task LoadTeacherData()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();

            // Test if server is running
            try
            {
                var healthResponse = await Http.GetAsync($"{ApiConfig.BaseUrl}api/health");
            }
            catch (Exception healthEx)
            {
                errorMessage = "Server is not running. Please start the server first.";
                return;
            }
            
            // Load teacher class information first (try to load, but don't fail completely if this fails)
            // Add timestamp to prevent caching
            var cacheBuster = DateTime.Now.Ticks;
            try
            {
                var teacherInfoResponse = await Http.GetFromJsonAsync<TeacherClassInfo>($"{ApiConfig.BaseUrl}api/teacher/info/{teacherInfo.UserId}?t={cacheBuster}");
                
                if (teacherInfoResponse != null)
                {
                    classInfo = teacherInfoResponse;
                    Console.WriteLine($"DEBUG: Loaded teacher info - FullName: {classInfo.FullName}");
                }
            }
            catch (Exception teacherInfoEx)
            {
                Console.WriteLine($"DEBUG: Error loading teacher info: {teacherInfoEx.Message}");
                // Don't return early - continue to try loading dashboard data
            }
            
            // Load teacher dashboard data (this is the main data we need)
            // Add timestamp to prevent caching
            var response = await Http.GetFromJsonAsync<TeacherDashboardData>($"{ApiConfig.BaseUrl}api/teacher/dashboard/{teacherInfo.UserId}?t={cacheBuster}");
            if (response != null)
            {
                students = response.Students ?? new List<Student>();
                studentsAtRisk = response.StudentsAtRisk ?? new List<Student>();
                teacherInfo = response.TeacherInfo ?? teacherInfo;
                
                // If we got dashboard data with class info, use it BUT preserve the correct FullName from teacherInfoResponse
                if (response.ClassInfo != null)
                {
                    // Use the classInfo from dashboard but keep the correct FullName from the first API call
                    var correctFullName = classInfo?.FullName ?? response.ClassInfo.FullName;
                    classInfo = response.ClassInfo;
                    // Override with the correct FullName if we got it from the first API call
                    if (!string.IsNullOrEmpty(correctFullName) && correctFullName != "tech2" && correctFullName != response.ClassInfo.FullName)
                    {
                        classInfo.FullName = correctFullName;
                        Console.WriteLine($"DEBUG: Fixed FullName from '{response.ClassInfo.FullName}' to '{correctFullName}'");
                    }
                    Console.WriteLine($"DEBUG: Updated classInfo from dashboard - FullName: {classInfo.FullName}");
                }
                
                // Clear any previous errors
                if (students.Count > 0)
                {
                    errorMessage = string.Empty;
                }
            }
            else
            {
                errorMessage = "Failed to load teacher dashboard data. Please check if students are assigned to your class.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<int> GetStudentAbsencesAsync(string studentId)
    {
        try
        {
            var response = await Http.GetFromJsonAsync<dynamic>($"{ApiConfig.BaseUrl}api/teacher/student-absences/{studentId}");
            if (response != null && response.absences != null)
            {
                return (int)response.absences;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting absences for student {studentId}: {ex.Message}");
        }
        
        return 0;
    }

    private int GetStudentAbsences(string studentId)
    {
        if (studentAbsences.ContainsKey(studentId))
        {
            return studentAbsences[studentId];
        }
        
        // Return 0 as default, will be updated by API call
        return 0;
    }

    private string GetStudentStatus(int absences)
    {
        return absences switch
        {
            >= 3 => "Flagged",
            >= 1 => "At Risk",
            _ => "Good"
        };
    }

    private void ViewStudentDetails(string studentId)
    {
        // TODO: Implement student details view
        Console.WriteLine($"Viewing details for student: {studentId}");
    }

    private async Task ExportReport()
    {
        try
        {
            if (students == null || !students.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "No student data available to export.");
                return;
            }

            // Prepare data for PDF export
            var reportData = new
            {
                schoolName = classInfo?.SchoolName ?? "N/A",
                gradeLevel = classInfo?.GradeLevel ?? 0,
                section = classInfo?.Section ?? "N/A",
                adviserName = classInfo?.FullName ?? "N/A",
                reportDate = DateTime.Now.ToString("MMMM dd, yyyy"),
                reportTime = DateTime.Now.ToString("hh:mm tt"),
                totalStudents = students.Count,
                studentsAtRisk = studentsAtRisk?.Count ?? 0,
                maleStudents = students.Where(s => s.Gender?.ToLower() == "male")
                    .OrderBy(s => s.FullName)
                    .Select(s => new { fullName = s.FullName, absences = s.AbsenceCount, status = s.Status })
                    .ToList(),
                femaleStudents = students.Where(s => s.Gender?.ToLower() == "female")
                    .OrderBy(s => s.FullName)
                    .Select(s => new { fullName = s.FullName, absences = s.AbsenceCount, status = s.Status })
                    .ToList()
            };

            // Generate filename
            var fileName = $"AttendanceReport_Grade{classInfo?.GradeLevel}_{classInfo?.Section}_{DateTime.Now:yyyyMMdd}.pdf";
            
            // Serialize to JSON and export to PDF using JavaScript
            var jsonData = System.Text.Json.JsonSerializer.Serialize(reportData);
            await JSRuntime.InvokeVoidAsync("exportToPDF", jsonData, fileName);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error exporting report: {ex.Message}");
        }
    }

    private void GenerateAnalytics()
    {
        // TODO: Implement analytics generation
        Console.WriteLine("Generating analytics...");
    }

    private async Task RefreshData()
    {
        await LoadTeacherData();
    }

    private void NavigateToDailyAttendance()
    {
        Navigation.NavigateTo("/daily-attendance");
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        // No cleanup needed
    }
}

<style>
    .text-pink {
        color: #e91e63 !important;
    }
    
    .table-primary {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    .table-info {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }
    
    .card {
        border: none;
        border-radius: 10px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        border: none;
    }
    
    .btn {
        border-radius: 8px;
    }
    
    .btn-warning {
        background-color: #8b7355 !important;
        border-color: #8b7355 !important;
    }
    
    .btn-warning:hover {
        background-color: #7a6248 !important;
        border-color: #7a6248 !important;
    }
    
    .bg-warning {
        background-color: #8b7355 !important;
    }
    
    .table-warning {
        background-color: rgba(139, 115, 85, 0.1) !important;
    }
    
    .badge {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .fs-6 {
        font-size: 1rem !important;
    }
    
    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .btn-lg {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        
        .d-flex.gap-3 {
            flex-direction: column;
            gap: 0.5rem !important;
        }
        
        .d-flex.gap-3 .btn {
            width: 100%;
        }
    }
</style>
