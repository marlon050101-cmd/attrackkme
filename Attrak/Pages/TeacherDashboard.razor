@page "/teacher-dashboard"
@using AttrackSharedClass.Models
@using Attrak.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IAuthService AuthService
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@layout Layoutall
@implements IAsyncDisposable

@code {
    private List<Student>? students;
    private List<Student>? studentsAtRisk;
    private UserInfo? teacherInfo;
    private TeacherClassInfo? classInfo;
    private bool isLoading = true;
    private bool isHubConnected = false;
    private string errorMessage = string.Empty;
    private Dictionary<string, int> studentAbsences = new();
    private HubConnection? hubConnection;

    private async Task LoadStudentsOnly()
    {
        if (teacherInfo == null) return;
        
        try
        {
            var cacheBuster = DateTime.Now.Ticks;
            var studentsResponse = await Http.GetFromJsonAsync<List<Student>>($"{ApiConfig.BaseUrl}api/teacher/students/{teacherInfo.UserId}?t={cacheBuster}");
            if (studentsResponse != null)
            {
                students = studentsResponse;
                // Update students at risk
                studentsAtRisk = students.Where(s => s.AbsenceCount >= 3).ToList();
                Console.WriteLine($"DEBUG: SignalR - Student list refreshed locally ({students.Count} students).");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DEBUG: Error refreshing student list: {ex.Message}");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        teacherInfo = await AuthService.GetCurrentUserAsync();
        
        if (teacherInfo == null)
        {
            errorMessage = "Please log in to access this dashboard.";
            isLoading = false;
            return;
        }

        if (teacherInfo.UserType != UserType.Teacher)
        {
            errorMessage = "Access denied. This dashboard is only for teachers.";
            isLoading = false;
            return;
        }

        // Initialize SignalR Hub Connection
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl($"{ApiConfig.BaseUrl}attendanceHub")
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<System.Text.Json.JsonElement>("ReceiveAttendanceUpdate", async (update) =>
            {
                Console.WriteLine($"DEBUG: SignalR - Received update! Payload: {update.GetRawText()}");
                
                // If it's a system message or test message, just log it
                if (update.TryGetProperty("StudentName", out var nameProp) && 
                    (nameProp.GetString() == "SYSTEM" || nameProp.GetString() == "TEST" || nameProp.GetString() == "GROUP TEST"))
                {
                    var statusStr = update.TryGetProperty("Status", out var statusProp) ? statusProp.GetString() : "Unknown";
                    Console.WriteLine($"DEBUG: SignalR System Message: {nameProp.GetString()} - {statusStr}");
                    return;
                }

                // Use InvokeAsync to ensure UI thread update and separate refresh for students
                await InvokeAsync(async () => {
                    await LoadStudentsOnly();
                    StateHasChanged();
                });
            });

            await hubConnection.StartAsync();
            isHubConnected = hubConnection.State == HubConnectionState.Connected;
            
            // Join the groups for this teacher - join both IDs for maximum reliability
            if (isHubConnected)
            {
                // Join alphanumeric ID group
                if (!string.IsNullOrEmpty(teacherInfo.TeacherId))
                {
                    await hubConnection.SendAsync("JoinClassGroup", teacherInfo.TeacherId);
                }
                
                // Join GUID group
                await hubConnection.SendAsync("JoinClassGroup", teacherInfo.UserId);
            }
        }
        catch (Exception sigEx)
        {
            Console.WriteLine($"DEBUG: SignalR connection error: {sigEx.Message}");
            isHubConnected = false;
        }

        // Load teacher data from API
        await LoadTeacherData();
    }

    private async Task TestSignalR()
    {
        if (hubConnection == null || !isHubConnected) 
        {
            Console.WriteLine("DEBUG: SignalR - Cannot test, not connected.");
            return;
        }

        try 
        {
            Console.WriteLine("DEBUG: SignalR - Sending test signal...");
            await hubConnection.SendAsync("TestConnection", teacherInfo.UserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DEBUG: SignalR Test Error: {ex.Message}");
        }
    }

    private async Task LoadTeacherData()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();

            // Test if server is running
            try
            {
                var healthResponse = await Http.GetAsync($"{ApiConfig.BaseUrl}api/health");
                if (!healthResponse.IsSuccessStatusCode)
                {
                    errorMessage = "Server is not responding correctly.";
                    return;
                }
            }
            catch (Exception)
            {
                errorMessage = "Server is not running. Please start the server first.";
                return;
            }
            
            // Unified dashboard data fetch
            var cacheBuster = DateTime.Now.Ticks;
            var response = await Http.GetFromJsonAsync<TeacherDashboardData>($"{ApiConfig.BaseUrl}api/teacher/dashboard/{teacherInfo.UserId}?t={cacheBuster}");
            
            if (response != null)
            {
                students = response.Students ?? new List<Student>();
                studentsAtRisk = response.StudentsAtRisk ?? new List<Student>();
                
                // Update local teacher info if the API returned it
                if (response.TeacherInfo != null)
                {
                    teacherInfo = response.TeacherInfo;
                }

                // Map class information
                if (response.ClassInfo != null)
                {
                    classInfo = response.ClassInfo;
                    
                    // Priority for FullName: ClassInfo.FullName -> teacherInfo.FullName -> teacherInfo.Username
                    if (string.IsNullOrEmpty(classInfo.FullName) || classInfo.FullName == "tech2")
                    {
                        classInfo.FullName = teacherInfo?.Username ?? "Teacher";
                    }
                }
                
                Console.WriteLine($"DEBUG: Dashboard loaded - {students.Count} students found.");
                
                if (students.Count == 0)
                {
                    Console.WriteLine("DEBUG: No students found in the dashboard response.");
                }
            }
            else
            {
                errorMessage = "Failed to load dashboard data. No response from server.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DEBUG: LoadTeacherData Error: {ex.Message}");
            errorMessage = $"An error occurred while loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<int> GetStudentAbsencesAsync(string studentId)
    {
        try
        {
            var response = await Http.GetFromJsonAsync<System.Text.Json.JsonElement>($"{ApiConfig.BaseUrl}api/teacher/student-absences/{studentId}");
            if (response.ValueKind != System.Text.Json.JsonValueKind.Undefined && response.TryGetProperty("absences", out var absProp))
            {
                return absProp.GetInt32();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting absences for student {studentId}: {ex.Message}");
        }
        
        return 0;
    }

    private int GetStudentAbsences(string studentId)
    {
        if (studentAbsences.ContainsKey(studentId))
        {
            return studentAbsences[studentId];
        }
        
        // Return 0 as default, will be updated by API call
        return 0;
    }

    private string GetStudentStatus(int absences)
    {
        return absences switch
        {
            >= 3 => "Flagged",
            >= 1 => "At Risk",
            _ => "Good"
        };
    }

    private void ViewStudentDetails(string studentId)
    {
        Console.WriteLine($"DEBUG: Viewing details for student: {studentId}");
        Navigation.NavigateTo($"/student-details/{studentId}");
    }

    private async Task ExportReport()
    {
        try
        {
            if (students == null || !students.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "No student data available to export.");
                return;
            }

            // Prepare data for PDF export
            var reportData = new
            {
                schoolName = classInfo?.SchoolName ?? "N/A",
                gradeLevel = classInfo?.GradeLevel ?? 0,
                section = classInfo?.Section ?? "N/A",
                adviserName = classInfo?.FullName ?? "N/A",
                reportDate = DateTime.Now.ToString("MMMM dd, yyyy"),
                reportTime = DateTime.Now.ToString("hh:mm tt"),
                totalStudents = students.Count,
                studentsAtRisk = studentsAtRisk?.Count ?? 0,
                maleStudents = students.Where(s => s.Gender?.ToLower() == "male")
                    .OrderBy(s => s.FullName)
                    .Select(s => new { fullName = s.FullName, absences = s.AbsenceCount, status = s.Status })
                    .ToList(),
                femaleStudents = students.Where(s => s.Gender?.ToLower() == "female")
                    .OrderBy(s => s.FullName)
                    .Select(s => new { fullName = s.FullName, absences = s.AbsenceCount, status = s.Status })
                    .ToList()
            };

            // Generate filename
            var fileName = $"AttendanceReport_Grade{classInfo?.GradeLevel}_{classInfo?.Section}_{DateTime.Now:yyyyMMdd}.pdf";
            
            // Serialize to JSON and export to PDF using JavaScript
            var jsonData = System.Text.Json.JsonSerializer.Serialize(reportData);
            await JSRuntime.InvokeVoidAsync("exportToPDF", jsonData, fileName);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error exporting report: {ex.Message}");
        }
    }

    private void GenerateAnalytics()
    {
        // TODO: Implement analytics generation
        Console.WriteLine("Generating analytics...");
    }

    private async Task RefreshData()
    {
        await LoadTeacherData();
    }

    private void NavigateToDailyAttendance()
    {
        Navigation.NavigateTo("/daily-attendance");
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

<PageTitle>Teacher Dashboard - Attrak</PageTitle>

<div class="container-fluid">

    <!-- Dashboard Local Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0" style="color: var(--text-main);">Teacher Dashboard</h2>
            <p class="text-muted small mb-0">Student Attendance Monitoring System</p>
        </div>
        <button class="btn btn-outline-danger btn-sm rounded-pill px-4 py-2" @onclick="Logout">
            <i class="fas fa-sign-out-alt me-1"></i> Logout
        </button>
    </div>

    <!-- Class Information Strip -->
    <div class="info-strip shadow-sm p-3 mb-4 bg-white-opacity">
        <div class="row g-0 align-items-center">
            <div class="col-md-3 text-center border-end">
                <span class="text-muted small text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">Grade Level</span>
                <span class="fw-bold">Grade @(classInfo?.GradeLevel ?? 0)</span>
            </div>
            <div class="col-md-3 text-center border-end">
                <span class="text-muted small text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">Section</span>
                <span class="fw-bold text-uppercase">@(classInfo?.Section ?? "N/A")</span>
            </div>
            <div class="col-md-3 text-center border-end px-2">
                <span class="text-muted small text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">School</span>
                <span class="fw-bold small text-truncate d-block">@(classInfo?.SchoolName ?? "N/A")</span>
            </div>
            <div class="col-md-3 text-center">
                <span class="text-muted small text-uppercase fw-bold d-block mb-1" style="font-size: 0.7rem;">Adviser</span>
                <span class="fw-bold">@(classInfo?.FullName ?? "N/A")</span>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-5 g-4">
        <div class="col-md-6">
            <div class="card-elegant p-4 position-relative overflow-hidden border-start border-primary border-4 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted small text-uppercase fw-bold">TOTAL STUDENTS</span>
                        @if (students != null)
                        {
                            var activeStudents = students.Where(s => s.Gender?.ToLower() == "male" || s.Gender?.ToLower() == "female").ToList();
                            <h1 class="display-4 fw-bold mb-0 mt-1">@activeStudents.Count</h1>
                        }
                        else
                        {
                            <h1 class="display-4 fw-bold mb-0 mt-1">0</h1>
                        }
                    </div>
                    <div class="stat-icon-wrapper">
                        <div class="gcash-pill">
                            <span class="gcash-icon">S</span>
                            <span class="gcash-text">GCash</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-elegant p-4 position-relative overflow-hidden border-start border-warning border-4 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted small text-uppercase fw-bold">STUDENTS AT RISK</span>
                        <h1 class="display-4 fw-bold mb-0 mt-1 text-warning">@(studentsAtRisk?.Count ?? 0)</h1>
                    </div>
                    <div class="stat-icon-large">
                        <i class="fas fa-user-clock text-warning" style="font-size: 3.5rem; opacity: 0.8;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Table Section -->
    <div class="row">
        <div class="col-12">
            <div class="card-elegant overflow-hidden">
                <div class="table-header d-flex justify-content-between align-items-center p-4">
                    <div>
                        <h5 class="mb-0 fw-bold">Student Attendance Report</h5>
                        <div class="d-flex align-items-center mt-1">
                            <div class="connection-dot @(isHubConnected ? "connected" : "disconnected")"></div>
                            <span class="text-muted" style="font-size: 0.7rem;">Real-time: @(isHubConnected ? "Connected" : "Disconnected")</span>
                            @if (isHubConnected)
                            {
                                <button class="btn btn-link py-0 px-2 text-primary" style="font-size: 0.65rem;" @onclick="TestSignalR">Test Signal</button>
                            }
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3" @onclick="LoadStudentsOnly">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                        <button class="btn btn-primary btn-sm rounded-pill px-4" @onclick="NavigateToDailyAttendance">
                            <i class="fas fa-calendar-alt me-1"></i> Daily Attendance
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-header-custom">
                            <tr>
                                <th class="ps-4">No.</th>
                                <th>Gender</th>
                                <th>Full Name</th>
                                <th class="text-center">Absences</th>
                                <th class="text-center">Status</th>
                                <th class="text-center pe-4">Action</th>
                            </tr>
                        </thead>
                            <tbody>
                            @if (students?.Any() == true)
                            {
                                var maleStudents = students.Where(s => s.Gender?.ToLower() == "male").ToList();
                                var femaleStudents = students.Where(s => s.Gender?.ToLower() == "female").ToList();

                                @if (maleStudents.Any())
                                {
                                    <tr class="table-group-header">
                                        <th colspan="6" class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-bars me-3 text-muted"></i>
                                                <i class="fas fa-mars text-primary me-2"></i>
                                                <span class="text-primary fw-bold">Male Students</span>
                                            </div>
                                        </th>
                                    </tr>
                                    @for (int i = 0; i < maleStudents.Count; i++)
                                    {
                                        var student = maleStudents[i];
                                        var absences = student.AbsenceCount;
                                        var status = student.Status;
                                        <tr>
                                            <td class="ps-4 text-muted small"> @(i + 1) </td>
                                            <td>
                                                <span class="gender-badge male">@student.Gender</span>
                                            </td>
                                            <td class="fw-semibold" style="color: var(--text-main);">@student.FullName.ToUpper()</td>
                                            <td class="text-center">
                                                <span class="absence-circle @(absences >= 3 ? "danger" : absences >= 1 ? "warning" : "success")">@absences</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="status-badge-soft @(absences >= 3 ? "danger" : absences >= 1 ? "warning" : "success")">
                                                    @status
                                                </span>
                                            </td>
                                            <td class="text-center pe-4">
                                                <button class="btn btn-detail-outline" @onclick="() => ViewStudentDetails(student.StudentId)">
                                                    Details
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }

                                @if (femaleStudents.Any())
                                {
                                    <tr class="table-group-header">
                                        <th colspan="6" class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-bars me-3 text-muted"></i>
                                                <i class="fas fa-venus text-danger me-2"></i>
                                                <span class="text-danger fw-bold">Female Students</span>
                                            </div>
                                        </th>
                                    </tr>
                                    @for (int i = 0; i < femaleStudents.Count; i++)
                                    {
                                        var student = femaleStudents[i];
                                        var absences = student.AbsenceCount;
                                        var status = student.Status;
                                        <tr>
                                            <td class="ps-4 text-muted small"> @(i + 1) </td>
                                            <td>
                                                <span class="gender-badge female">@student.Gender</span>
                                            </td>
                                            <td class="fw-semibold" style="color: var(--text-main);">@student.FullName.ToUpper()</td>
                                            <td class="text-center">
                                                <span class="absence-circle @(absences >= 3 ? "danger" : absences >= 1 ? "warning" : "success")">@absences</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="status-badge-soft @(absences >= 3 ? "danger" : absences >= 1 ? "warning" : "success")">
                                                    @status
                                                </span>
                                            </td>
                                            <td class="text-center pe-4">
                                                <button class="btn btn-detail-outline" @onclick="() => ViewStudentDetails(student.StudentId)">
                                                    Details
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <p class="mb-0">No students found for this class.</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-center gap-4">
                <button class="btn btn-export-mockup btn-lg px-5" @onclick="async () => await ExportReport()">
                    <i class="fas fa-download me-2"></i>Export Report
                </button>
                <button class="btn btn-analytics-mockup btn-lg px-5" @onclick="GenerateAnalytics">
                    <i class="fas fa-chart-bar me-2"></i>Generate Analytics
                </button>
            </div>
        </div>
    </div>
</div>


<style>
    .bg-white-opacity { background: rgba(255, 255, 255, 0.05); }
    
    .card-elegant {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card-elegant:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .connection-dot.connected {
        background-color: #10b981; /* Green */
        box-shadow: 0 0 5px #10b981;
    }
    
    .connection-dot.disconnected {
        background-color: #ef4444; /* Red */
    }

    .info-strip {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
    }

    .stat-icon-wrapper {
        background: #fff9e6;
        padding: 0.5rem;
        border-radius: 12px;
    }

    .gcash-pill {
        display: flex;
        align-items: center;
        background: #ffcc00;
        padding: 0.3rem 0.8rem;
        border-radius: 50px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .gcash-icon {
        background: #fff;
        color: #ffcc00;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        margin-right: 5px;
    }

    .gcash-text { font-size: 0.8rem; }

    .table-header-custom {
        background: #f8fafc;
        border-bottom: 2px solid var(--border-color);
    }

    [data-theme="dark"] .table-header-custom { background: #1e293b; }

    .table-header-custom th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        padding: 1rem 0.5rem;
    }

    .table-group-header {
        background: rgba(59, 130, 246, 0.05);
    }

    .gender-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-weight: 500;
    }

    .gender-badge.male { background: #dbeafe; color: #1d4ed8; }
    .gender-badge.female { background: #fce7f3; color: #be185d; }

    .status-badge-soft {
        font-size: 0.75rem;
        padding: 0.35rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }

    .status-badge-soft.success { background: #ecfdf5; color: #059669; }
    .status-badge-soft.warning { background: #fffbeb; color: #d97706; }
    .status-badge-soft.danger { background: #fef2f2; color: #dc2626; }

    .absence-circle {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .absence-circle.success { background: #dcfce7; color: #166534; }
    .absence-circle.warning { background: #fef3c7; color: #92400e; }
    .absence-circle.danger { background: #fee2e2; color: #991b1b; }

    .btn-detail-outline {
        border: 1px solid #e2e8f0;
        background: #ffffff;
        color: #64748b;
        font-size: 0.75rem;
        padding: 0.25rem 1rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-detail-outline:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #334155;
    }

    .btn-export-mockup {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
    }

    .btn-analytics-mockup {
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(23, 162, 184, 0.3);
    }

    .btn-export-mockup:hover, .btn-analytics-mockup:hover {
        transform: translateY(-1px);
        opacity: 0.95;
    }

    @@media (max-width: 768px) {
        .stat-icon-large { display: none; }
    }
</style>
